<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ui-cust-valid-attr-h">

  <select id="findByProperties" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.CustValidAttrHistoryDto">
    select t.work_no, t.valid_code, t.cond_type, t.item_code, t.attr_uuid, t.work_type_code,
    t.valid_start_dtm, t.valid_end_dtm, t.upd_user_dept_name, t.attr_val_upd_user, t.rgst_user, t.rgst_dtm, t.upd_user, t.upd_dtm
    FROM tb_cust_valid_attr_h t
  </select>

  <insert id="insert">
	INSERT INTO tb_cust_valid_attr_h
    (work_no, valid_code, cond_type, item_code, attr_uuid, work_type_code, valid_start_dtm, valid_end_dtm, upd_user_dept_name, attr_val_upd_user, rgst_user, rgst_dtm, upd_user, upd_dtm)
    VALUES (#{workNo}, #{validCode}, #{condType}, #{itemCode}, #{attrUuid}, #{workTypeCode}, TO_TIMESTAMP(#{validStartDtm}, 'YYYY-MM-DD HH24:MI:SS'), TO_TIMESTAMP(#{validEndDtm}, 'YYYY-MM-DD HH24:MI:SS'), #{updUserDeptName}, #{attrValUpdUser}, #{rgstUser}, CURRENT_TIMESTAMP, #{updUser}, CURRENT_TIMESTAMP)
  </insert>

  <select id="findByValidCodeAndAttrUuid" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.CustValidAttrHistoryDto">
    select t.work_no, t.valid_code, t.cond_type, t.item_code, t.attr_uuid, t.work_type_code,
    t.valid_start_dtm, t.valid_end_dtm, t.upd_user_dept_name, t.attr_val_upd_user, t.rgst_user, t.rgst_dtm, t.upd_user, t.upd_dtm
    FROM tb_cust_valid_attr_h t where t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid}
    order by t.work_no desc
  </select>

  <select id="countByValidCodeAndAttrUuid" resultType="int">
    select count(*)
    FROM tb_cust_valid_attr_h t where t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid}
  </select>

  <select id="findDate" resultType="string">
    select TO_CHAR(TO_TIMESTAMP(t.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') as workNo
    FROM tb_cust_valid_attr_h t
    where t.valid_code = #{validCode}
    group by workNo
  </select>

  <select id="findHistory" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.CustValidAttrHistoryDto">
    select TO_CHAR(TO_TIMESTAMP(t.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') as workNo, t.valid_code, t.cond_type, t.item_code, t.attr_uuid, t.work_type_code, t1.label_id,
    t.valid_start_dtm, t.valid_end_dtm, t.upd_user_dept_name, t.attr_val_upd_user, t.rgst_user, t.rgst_dtm, t.upd_user, t.upd_dtm,
    t2.item_code_name
    FROM tb_cust_valid_attr_h t
    inner join tb_add_attr_header_m t1 on t.attr_uuid = t1. attr_uuid
    left join tb_item_c t2 on t2.item_code = t1.item_code
    where t.valid_code = #{validCode} and TO_CHAR(TO_TIMESTAMP(t.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') = #{date}
  </select>

</mapper>