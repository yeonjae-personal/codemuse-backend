<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-impact">

  <select id="getParentProdM" resultType="com.lgcns.svcp.prod.ui.prod.dto.analysis.ItemDto">
    <![CDATA[
    SELECT
    parent.obj_uuid as prod_uuid
    , parent.obj_code AS prod_item_cd
    , parent.obj_name AS prod_item_nm
    , parent.valid_start_dtm
    , parent.valid_end_dtm
    FROM tb_item_mpng_d parent
    JOIN tb_item_mpng_d child ON child.dplc_trgt_uuid = parent.obj_uuid
    WHERE
    child.obj_uuid = #{prodUuid}
    ]]>
  </select>

  <select id="getSiblingsProdM" resultType="com.lgcns.svcp.prod.ui.prod.dto.analysis.ItemDto">
    <![CDATA[
    SELECT
    sibling.obj_uuid as prod_uuid
    , sibling.obj_code AS prod_item_cd
    , sibling.obj_name AS prod_item_nm
    , sibling.valid_start_dtm
    , sibling.valid_end_dtm
    FROM tb_item_mpng_d original
    JOIN tb_item_mpng_d sibling ON original.dplc_trgt_uuid = sibling.dplc_trgt_uuid
    WHERE
    original.obj_uuid = #{prodUuid}
    AND original.obj_uuid <> sibling.obj_uuid
    ]]>
  </select>
  
   <select id="getChildrenProdM" resultType="com.lgcns.svcp.prod.ui.prod.dto.analysis.ItemDto">
	SELECT
		child.obj_uuid AS prod_uuid,
		child.obj_code AS prod_item_cd,
		child.obj_name AS prod_item_nm,
		child.valid_start_dtm,
		child.valid_end_dtm
	FROM
		tb_item_mpng_d original
	JOIN
		tb_item_mpng_d child ON child.dplc_trgt_uuid = original.obj_uuid
	WHERE
		original.obj_uuid = #{prodUuid}
  </select>

  <resultMap id="retrieveItemsResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.analysis.ItemDto">
    <association property="baseProdItemCount" column="{trgtUuid=trgt_uuid_count}"  select="getBaseProdItemCount"/>
    <association property="trgtProdItemCount" column="{baseUuid=base_uuid_count}"  select="getTrgtProdItemCount"/>
  </resultMap>

  <select id="retrieveItemsPagedList" resultMap="retrieveItemsResultMap">
    SELECT
    a.obj_uuid as prod_uuid
    , a.obj_uuid as obj_uuid
    , a.valid_start_dtm
    , a.valid_end_dtm
    , a.obj_code as prod_item_cd
    , a.obj_code as obj_code
    , a.obj_name as prod_item_nm
    , a.obj_name as obj_name
    , a.item_code as item_code
    , d.lctgr_item_name as type
    , c.mctgr_item_name AS detl_type
    , b.item_code_name AS sub_type
    , a.obj_uuid as base_uuid_count
    , a.obj_uuid as trgt_uuid_count
    FROM tb_item_mpng_d a
    JOIN tb_item_c b  ON a.item_code = b.item_code
    JOIN tb_mctgr_item_c c ON b.mctgr_item_code = c.mctgr_item_code
    JOIN tb_lctgr_item_c d ON c.lctgr_item_code = d.lctgr_item_code
    <where>
    <if test="type != null">
    AND d.lctgr_item_code = #{type}
    </if>
    <if test="detlType != null">
    AND c.mctgr_item_code = #{detlType}
    </if>
    <if test="subType != null">
    AND b.item_code = #{subType}
    </if>
    <if test="prodItemCd != null">
    AND a.obj_code LIKE <![CDATA[ '%' || TRIM(UPPER(#{prodItemCd})) || '%']]>
    </if>
    <if test="prodItemNm != null">
    AND UPPER(a.obj_name) LIKE <![CDATA[ '%' || TRIM(UPPER(#{prodItemNm})) || '%']]>
    </if>
    <if test="onlyValidDtm">
      AND (a.valid_end_dtm IS NULL OR a.valid_end_dtm >= CURRENT_TIMESTAMP)
    </if>
    </where>
  </select>

  <select id="retrieveProductStructureListView" resultType="com.lgcns.svcp.prod.ui.prod.dto.analysis.ProductStructureDto">
    SELECT
	    c.obj_code AS offr_cd,
	    c.obj_name AS offr_nm,
	    d.obj_code AS cmp_cd,
	    d.obj_name AS cmp_nm,
	    a.valid_start_dtm AS cmp_vald_strt_dtm,
	    a.valid_end_dtm AS cmp_vald_end_dtm,
	    e.obj_code AS svc_cd,
	    e.obj_name AS svc_nm,
	    b.valid_start_dtm AS svc_vald_strt_dtm,
	    b.valid_end_dtm AS svc_vald_end_dtm
	FROM tb_item_mpng_d c
	FULL OUTER JOIN tb_offer_strc_d a ON c.obj_uuid = a.base_uuid
	FULL OUTER JOIN tb_item_mpng_d d ON a.trgt_uuid = d.obj_uuid
	FULL OUTER JOIN tb_offer_strc_d b ON d.obj_uuid = b.base_uuid
	FULL OUTER JOIN tb_item_mpng_d e ON b.trgt_uuid = e.obj_uuid
	WHERE 1=1
	<if test="offrUuid != null">
	    AND c.obj_uuid = #{offrUuid}
	</if>
	<if test="cmpUuid != null">
	    AND d.obj_uuid = #{cmpUuid}
	</if>
	<if test="svcUuid != null">
	    AND e.obj_uuid = #{svcUuid}
	</if>
	<choose>
	    <when test="lctgrItemCode != null">
	        <choose>
	            <when test="lctgrItemCode == 'O'.toString()">
	                <if test="objCode != null">
	                    AND LOWER(c.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                </if>
	                <if test="objName != null">
	                    AND LOWER(c.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                </if>
	            </when>
	            <when test="lctgrItemCode == 'C'.toString()">
	                <if test="objCode != null">
	                    AND LOWER(d.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                </if>
	                <if test="objName != null">
	                    AND LOWER(d.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                </if>
	            </when>
	            <when test="lctgrItemCode == 'R'.toString()">
	                <if test="objCode != null">
	                    AND LOWER(e.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                </if>
	                <if test="objName != null">
	                    AND LOWER(e.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                </if>
	            </when>
	        </choose>
	    </when>
	    <otherwise>
	        <if test="objCode != null or objName != null">
	            AND (
	                <trim prefixOverrides="OR ">
	                    <if test="objCode != null">
	                        OR LOWER(c.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                        OR LOWER(d.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                        OR LOWER(e.obj_code) LIKE LOWER(CONCAT('%', #{objCode}, '%'))
	                    </if>
	                    <if test="objName != null">
	                        OR LOWER(c.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                        OR LOWER(d.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                        OR LOWER(e.obj_name) LIKE LOWER(CONCAT('%', #{objName}, '%'))
	                    </if>
	                </trim>
	            )
	        </if>
	    </otherwise>
	</choose>
	AND (c.obj_uuid IS NOT NULL OR d.obj_uuid IS NOT NULL OR e.obj_uuid IS NOT NULL)
	ORDER BY cmp_cd, svc_cd
  </select>

  <select id="getBaseProdItemCount" resultType="int">
    SELECT COUNT(DISTINCT a.base_uuid) AS total_count
    FROM tb_offer_strc_d a
    JOIN tb_item_mpng_d b on -- TODO delete this line after the data in [tb_offer_strc_d] standard
    a.base_uuid = b.obj_uuid -- TODO delete this line after the data in [tb_offer_strc_d] standard
    WHERE a.trgt_uuid = #{trgtUuid}
  </select>

  <select id="getTrgtProdItemCount" resultType="int">
    SELECT COUNT(DISTINCT a.trgt_uuid) AS total_count
    FROM tb_offer_strc_d a
    JOIN tb_item_mpng_d b on -- TODO delete this line after the data in [tb_offer_strc_d] standard
    a.trgt_uuid = b.obj_uuid -- TODO delete this line after the data in [tb_offer_strc_d] standard
    WHERE a.base_uuid =  #{baseUuid}
  </select>

  <resultMap id="retrieveSearchInfoItemResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    <association property="subOptions" column="{lctgrItemCode=value}"  select="retrieveMctgrItemCode"/>
  </resultMap>

  <select id="retrieveSearchInfoItem" resultMap="retrieveSearchInfoItemResultMap">
    SELECT
    a.lctgr_item_code as value,
    a.lctgr_item_name as label,
    a.lctgr_item_code as cmcdDetlId,
    a.lctgr_item_name as cmcdDetlNm,
    a.sort_no
    FROM tb_lctgr_item_c a
    WHERE
    a.lctgr_item_code in ('O','C','R')
    AND a.use_yn = 'Y'
    ORDER BY a.sort_no
  </select>

  <resultMap id="retrieveMctgrItemCodeResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    <association property="subOptions" column="{mctgrItemCode=value}"  select="retrieveItemCode"/>
  </resultMap>

  <select id="retrieveMctgrItemCode" resultMap="retrieveMctgrItemCodeResultMap">
    SELECT
    a.mctgr_item_code as value,
    a.mctgr_item_name as label,
    a.mctgr_item_code as cmcdDetlId,
    a.mctgr_item_name as cmcdDetlNm,
    a.sort_no
    FROM tb_mctgr_item_c a
    WHERE
    a.lctgr_item_code = #{lctgrItemCode}
    AND a.use_yn = 'Y'
    ORDER BY a.sort_no
  </select>

  <select id="retrieveItemCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    SELECT
    a.item_code as value,
    a.item_code_name as label,
    a.item_code as cmcdDetlId,
    a.item_code_name as cmcdDetlNm,
    a.sort_no
    FROM tb_item_c a
    WHERE
    a.mctgr_item_code = #{mctgrItemCode}
    AND a.use_yn = 'Y'
    ORDER BY a.sort_no
  </select>

</mapper>