<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ui-cust-valid-val-h">

  <select id="findByProperties" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.CustValidValHistoryDto">
    select t.work_no, t.valid_code, t.cond_type, t.attr_uuid, t.attr_val, t.upd_user_dept_name, t.attr_val_upd_user,
    t.rgst_user, t.rgst_dtm, t.upd_user, t.upd_dtm
    FROM tb_cust_valid_val_h t
  </select>

  <insert id="insert">
	INSERT INTO tb_cust_valid_val_h
    (work_no, valid_code, cond_type, attr_uuid, attr_val, upd_user_dept_name, attr_val_upd_user, rgst_user, rgst_dtm, upd_user, upd_dtm)
    VALUES (#{workNo}, #{validCode}, #{condType}, #{attrUuid}, #{attrVal}, #{updUserDeptName}, #{attrValUpdUser}, #{rgstUser}, CURRENT_TIMESTAMP, #{updUser}, CURRENT_TIMESTAMP)
  </insert>

  <select id="findHistory" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.history.ValueChangeDto">
		<![CDATA[
		WITH CTE_Ranked as (
		SELECT
		TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') AS work_no, a.attr_uuid
		,TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') AS work_date
		,LAG(a.attr_val) OVER (PARTITION BY a.attr_uuid ORDER BY a.work_no) AS before_value
		,a.attr_val AS after_value
		,t.label_id, a.cond_type
		,ROW_NUMBER() OVER (PARTITION BY a.attr_uuid ORDER BY a.work_no) AS row_num
		,t1.item_code_name
		FROM tb_cust_valid_val_h a
		inner join tb_add_attr_header_m t on t.attr_uuid = a.attr_uuid
		left join tb_item_c t1 on t1.item_code = t.item_code
		where
		a.valid_code = #{validCode})
		SELECT
		work_no, attr_uuid
		, work_date
		, before_value
		, after_value
		, label_id
		, cond_type
		, item_code_name
		, row_num
		FROM cte_ranked
		WHERE
		work_no = #{workNo} and row_num > 1
		]]>
    </select>

  <select id="countByValidCodeAndAttrUuid" resultType="int">
    select count(*)
    FROM tb_cust_valid_val_h t where t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid}
  </select>

  <select id="findDate" resultType="string">
    select TO_CHAR(TO_TIMESTAMP(t.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD') AS workNo
    FROM tb_cust_valid_val_h t
    where t.valid_code = #{validCode}
    group by workNo
  </select>

</mapper>
