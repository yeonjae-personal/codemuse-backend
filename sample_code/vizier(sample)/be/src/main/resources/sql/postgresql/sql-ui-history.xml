<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-history">

  <select id="retrieveCreatedDate" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.EventDateDto">
    SELECT
    TO_CHAR(a.valid_start_dtm , 'YYYY-MM-DD') work_date
    ,a.chg_dept_name
    ,a.chg_user
    FROM tb_item_mpng_d a
    WHERE
    a.obj_uuid = #{objUuid}
  </select>

  <select id="retrieveEndedDate" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.EventDateDto">
    SELECT
    TO_CHAR(a.valid_end_dtm , 'YYYY-MM-DD') work_date
    ,a.chg_dept_name
    ,a.chg_user
    FROM tb_item_mpng_d a
    WHERE
    a.obj_uuid = #{objUuid}
    AND a.valid_end_dtm IS NOT NULL
  </select>

  <select id="retrieveAddtionalChanged" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.AttributeChangeDto">
    WITH CTE_Ranked AS (
    SELECT
    a.work_no
    , 'Attribute' AS change_type_name
    ,CASE
    WHEN a.work_no ~ '^[0-9]{14}$' THEN TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD')
    ELSE a.work_no
    END AS work_date
    , LAG(a.attr_val) OVER (PARTITION BY a.obj_uuid, b.label_id ORDER BY a.work_no) AS before_value
    , a.attr_val AS after_value
    , b.label_id
    , a.upd_user_dept_name AS chg_dept_name
    , a.attr_val_upd_user AS chg_user
    , ROW_NUMBER() OVER (PARTITION BY a.obj_uuid, b.label_id ORDER BY a.work_no) AS row_num
    , b.comm_group_code
    , b.field_type_code
    FROM tb_add_attr_val_h a
    JOIN tb_add_attr_header_m b
    ON a.attr_uuid = b.attr_uuid
    WHERE
    a.obj_uuid = #{objUuid}
    AND b.use_yn = 'Y'
    )
    SELECT
    work_no
    , change_type_name
    , work_date
    , before_value
    , after_value
    , label_id
    , chg_dept_name
    , chg_user
    , comm_group_code
    , field_type_code
    FROM cte_ranked
    WHERE
    row_num > 1
  </select>

  <select id="retrieveGeneralChanged" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.AttributeChangeDto">
    WITH CTE_Ranked AS (
    SELECT
    a.work_no
    , 'Attribute' AS change_type_name
    , CASE
    WHEN a.work_no ~ '^[0-9]{14}$' THEN TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS'), 'YYYY-MM-DD')
    ELSE a.work_no
    END AS work_date
    , LAG(a.attr_val) OVER (PARTITION BY a.obj_uuid,  a.attr_code ORDER BY a.work_no) AS before_value
    , a.attr_val AS after_value
    , a.attr_code AS label_id
    , a.upd_user_dept_name AS chg_dept_name
    , a.attr_val_upd_user AS chg_user
    , ROW_NUMBER() OVER (PARTITION BY a.obj_uuid, a.attr_code ORDER BY a.work_no) AS row_num
    FROM tb_gnrl_attr_val_h a
    WHERE
    a.obj_uuid = #{objUuid}
    )
    SELECT
    work_no
    , change_type_name
    , work_date
    , before_value
    , after_value
    , label_id
    , chg_dept_name
    , chg_user
    FROM cte_ranked
    WHERE
    row_num > 1
  </select>

  <select id="retrieveStructureOfferChanged" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.StructureChangeDto">
    SELECT
    a.work_no
    , a.work_type_code
    , 'Structure' change_type_name
    , TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS') , 'YYYY-MM-DD') work_date
    , a.trgt_uuid
    , a.upd_user_dept_name chg_dept_name
    , a.attr_val_upd_user chg_user
    , d.mctgr_item_name
    , c.item_code_name
    , b.obj_name
    FROM tb_offer_strc_h a
    JOIN tb_item_mpng_d b ON a.trgt_uuid = b.obj_uuid
    JOIN tb_item_c c ON b.item_code = c.item_code
    JOIN tb_mctgr_item_c d ON c.mctgr_item_code = d.mctgr_item_code
    WHERE
    a.base_uuid = #{objUuid}
    ORDER BY
    a.work_no
  </select>

  <select id="retrieveStructureOfferGroupChanged" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.detail.StructureChangeDto">
    SELECT
    a.work_no
    , a.work_type_code
    , 'Structure' change_type_name
    , TO_CHAR(TO_TIMESTAMP(a.work_no, 'YYYYMMDDHH24MISS') , 'YYYY-MM-DD') work_date
    , a.upd_user_dept_name chg_dept_name
    , a.attr_val_upd_user chg_user
    , d.mctgr_item_name
    , c.item_code_name
    , b.obj_name
    FROM tb_offer_group_rel_h a
    JOIN tb_item_mpng_d b ON a.offer_uuid = b.obj_uuid
    JOIN tb_item_c c ON b.item_code = c.item_code
    JOIN tb_mctgr_item_c d on c.mctgr_item_code = d.mctgr_item_code
    WHERE
    a.offer_group_uuid = #{objUuid}
    ORDER BY
    a.work_no
  </select>

  <insert id="insertAdditonalAttributeHist" parameterType="com.lgcns.svcp.prod.ui.prod.dto.history.save.AdditonalAttributeHistDto">
    INSERT INTO tb_add_attr_val_h (
    work_no
    , obj_uuid
    , attr_uuid
    , attr_val
    , upd_user_dept_name
    , attr_val_upd_user
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    )
    VALUES (
    #{workNo}
    , #{objUuid}
    , #{attrUuid}
    , #{attrVal}
    , #{updUserDeptName}
    , #{attrValUpdUser}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    )
  </insert>

  <insert id="insertGeneralAttributeHist" parameterType="com.lgcns.svcp.prod.ui.prod.dto.history.save.GeneralAttributeHistDto">
    INSERT INTO tb_gnrl_attr_val_h (
    work_no
    , obj_uuid
    , attr_code
    , attr_val
    , upd_user_dept_name
    , attr_val_upd_user
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    )
    VALUES (
    #{workNo}
    , #{objUuid}
    , #{attrCode}
    , #{attrVal}
    , #{updUserDeptName}
    , #{attrValUpdUser}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    )
  </insert>

  <insert id="insertOfferGroupRelHist" parameterType="com.lgcns.svcp.prod.ui.prod.dto.history.save.OfferGroupRelHistDto">
    INSERT INTO tb_offer_group_rel_h (
      work_no
      , offer_group_uuid
      , offer_uuid
      , valid_start_dtm
      , valid_end_dtm
      , work_type_code
      , upd_user_dept_name
      , attr_val_upd_user
      , rgst_user
      , rgst_dtm
      , upd_user
      , upd_dtm
      )
      VALUES (
      #{workNo}
      , #{offerGroupUuid}
      , #{offerUuid}
      , #{validStartDtm}::TIMESTAMP
      , #{validEndDtm}::TIMESTAMP
      , #{workTypeCode}
      , #{updUserDeptName}
      , #{attrValUpdUser}
      , #{rgstUser}
      , CURRENT_TIMESTAMP
      , #{updUser}
      , CURRENT_TIMESTAMP
      )
  </insert>

  <insert id="insertOfferStrcHist" parameterType="com.lgcns.svcp.prod.ui.prod.dto.history.save.OfferStrcHistDto">
    INSERT INTO tb_offer_strc_h (
        work_no,
        base_uuid,
        trgt_uuid,
        valid_start_dtm,
        valid_end_dtm,
        work_type_code,
        upd_user_dept_name,
        attr_val_upd_user,
        rgst_user,
        rgst_dtm,
        upd_user,
        upd_dtm
    )
    VALUES (
        #{workNo},
        #{baseUuid},
        #{trgtUuid},
        #{validStartDtm}::TIMESTAMP,
        #{validEndDtm}::TIMESTAMP,
        #{workTypeCode},
        #{updUserDeptName},
        #{attrValUpdUser},
        #{rgstUser},
        CURRENT_TIMESTAMP,
        #{updUser},
        CURRENT_TIMESTAMP
    );
  </insert>

  <select id="retrieveFirstAdditonalAttribute" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.save.AdditonalAttributeHistDto">
    SELECT
        b.rgst_dtm
        , b.obj_uuid
        , a.attr_uuid
        , b.chg_dept_name AS upd_user_dept_name
        , b.chg_user AS attr_val_upd_user
        , CASE
      WHEN a.field_type_code = 'DM' then (
      SELECT
      CAST(COALESCE(JSON_AGG(attr_val ORDER BY attr_seq), '[]')AS text) AS attr_val
      FROM tb_multi_code_add_attr_val_d
      WHERE
      attr_uuid = a.attr_uuid
      AND obj_uuid = b.obj_uuid
      )
      ELSE c.attr_val
      END AS attr_val
      FROM tb_add_attr_header_m a
      JOIN tb_item_mpng_d b ON b.item_code = a.item_code
      LEFT JOIN
      <choose>
      <when test="filters[0].lctgrItemCode.toString() == 'O'.toString()">
      tb_offer_add_attr_val_d c
      </when>
      <when test="filters[0].lctgrItemCode.toString() == 'C'.toString()">
      tb_cpnt_add_attr_val_d c
      </when>
      <when test="filters[0].lctgrItemCode.toString() == 'R'.toString()">
      tb_rsc_add_attr_val_d c
      </when>
      <when test="filters[0].lctgrItemCode.toString() == 'G'.toString()">
      tb_offer_group_add_attr_val_d c
      </when>
      <when test="filters[0].lctgrItemCode.toString() == 'B'.toString()">
      tb_offer_rel_add_attr_val_d c
      </when>
      </choose>
      ON a.attr_uuid = c.attr_uuid AND c.obj_uuid = b.obj_uuid
      LEFT JOIN tb_add_attr_val_h d ON b.obj_uuid = d.obj_uuid AND a.attr_uuid = d.attr_uuid
      WHERE
      a.use_yn = 'Y'
      AND d.obj_uuid IS NULL
      AND
      <foreach collection='filters' item='filter' open='(' separator='OR' close=")">
      (b.obj_uuid = #{filter.objUuid} AND a.attr_uuid = #{filter.attrUuid})
      </foreach>
  </select>

  <select id="retrieveGeneralNotInHistory" resultType="com.lgcns.svcp.prod.ui.prod.dto.history.save.GeneralAttributeHistDto">
    SELECT
    input.obj_uuid
    , input.attr_code
    , input.first_attr_val
    FROM
    (
    <foreach collection='list' item='item' separator="UNION ALL">
    SELECT
    #{item.objUuid} AS obj_uuid
    , #{item.attrCode} AS attr_code
    ,  #{item.firstAttrVal} as first_attr_val
    </foreach>
    ) input
    LEFT JOIN tb_gnrl_attr_val_h a ON input.obj_uuid = a.obj_uuid AND input.attr_code = a.attr_code
    WHERE
    a.obj_uuid IS NULL
  </select>

</mapper>