<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-factor">

  <select id="searchFactorType" resultType="com.lgcns.svcp.prod.ui.prod.dto.admin.factor.FactorTypeDto">
    SELECT
    a.factor_type_code
    , a.factor_type_name
    , a.use_yn
    , a.sort_no
    , a.rgst_user
    , a.rgst_dtm
    , a.upd_user
    , a.upd_dtm
    FROM tb_factor_type_c a
    <where>
    <if test="factorTypeCode != null">
    UPPER(a.factor_type_code) LIKE '%' || TRIM(UPPER(#{factorTypeCode}) || '%')
    </if>
    <if test="factorTypeName != null">
    AND UPPER(a.factor_type_name) LIKE '%' || TRIM(UPPER(#{factorTypeName}) || '%')
    </if>
    <if test="useYn != null">
    AND a.use_yn = UPPER(#{useYn})
    </if>
    </where>
    ORDER BY
    a.sort_no
  </select>
  
  <resultMap id="retrieveFactorResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.admin.factor.FactorDto">
    <association property="factorValueLst" column="{factorCode=factor_code,useYn=use_yn_param}"  select="retrieveFactorValue"/>
  </resultMap>

  <select id="searchFactor" resultMap="retrieveFactorResultMap">
    SELECT
    a.factor_code
    , a.factor_name
    , a.factor_type_code
    , a.use_yn
    , a.rgst_user
    , a.rgst_dtm
    , a.upd_user
    , a.upd_dtm
    , #{useYn} as use_yn_param
    FROM tb_factor_c a
    JOIN tb_factor_type_c b ON a.factor_type_code = b.factor_type_code
    <where>
    <if test="factorTypeCode != null">
    UPPER(a.factor_type_code) LIKE '%' || TRIM(UPPER(#{factorTypeCode}) || '%')
    </if>
    <if test="factorTypeName != null">
    UPPER(b.factor_type_name) LIKE '%' || TRIM(UPPER(#{factorTypeName}) || '%')
    </if>
    <if test="factorCode != null">
    AND UPPER(a.factor_code) LIKE '%' || TRIM(UPPER(#{factorCode}) || '%')
    </if>
    <if test="factorName != null">
    AND UPPER(a.factor_name) LIKE '%' || TRIM(UPPER(#{factorName}) || '%')
    </if>
    <if test="useYn != null">
    AND UPPER(a.use_yn) = UPPER(#{useYn})
    </if>
    </where>
    ORDER BY
    UPPER(a.factor_name)
  </select>

  <resultMap id="retrieveFactorTypeResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.admin.factor.FactorTypeDto">
    <association property="factorLst" column="{factorTypeCode=factor_type_code}"  select="retrieveFactorByFactorTypeCode"/>
  </resultMap>

  <select id="retrieveFactorType" resultMap="retrieveFactorTypeResultMap">
    SELECT
    a.factor_type_code
    , a.factor_type_name
    , a.use_yn
    , a.sort_no
    , a.rgst_user
    , a.rgst_dtm
    , a.upd_user
    , a.upd_dtm
    FROM tb_factor_type_c a
    WHERE
    a.factor_type_code = #{factorTypeCode}
  </select>

  <select id="retrieveFactorByFactorTypeCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.admin.factor.FactorDto">
    SELECT
    a.factor_code
    , a.factor_name
    , a.factor_type_code
    , a.use_yn
    , a.rgst_user
    , a.rgst_dtm
    , a.upd_user
    , a.upd_dtm
    FROM tb_factor_c a
    WHERE
    a.factor_type_code = #{factorTypeCode}
    ORDER BY
    UPPER(a.factor_name)
  </select>

  <update id="updateFactorType" >
    UPDATE tb_factor_type_c
    <set>
      , factor_type_name = #{factorTypeName}
      , use_yn = #{useYn}
      , sort_no = #{sortNo}
      , upd_user = #{updUser}
      , upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE
    factor_type_code = #{factorTypeCode};
  </update>

  <select id="retrieveFactorValue" resultType="com.lgcns.svcp.prod.ui.prod.dto.admin.factor.FactorValueDto">
    SELECT
    a.factor_value_code
    , a.factor_value_name
    , a.value
    , a.factor_code
    , a.use_yn
    , a.rgst_user
    , a.rgst_dtm
    , a.upd_user
    , a.upd_dtm
    FROM tb_factor_value_c a
    WHERE
    a.factor_code = #{factorCode}
    <if test="useYn != null">
    AND UPPER(a.use_yn) = UPPER(#{useYn})
    </if>
    ORDER BY
    UPPER(a.factor_value_name)
  </select>

  <insert id="saveFactor">
    INSERT INTO tb_factor_c (
    factor_code
    , factor_name
    , factor_type_code
    , use_yn
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    )
    VALUES (
    #{factorCode}
    , #{factorName}
    , #{factorTypeCode}
    , #{useYn}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    ) ON CONFLICT (factor_code) DO UPDATE SET factor_name = EXCLUDED.factor_name
    , use_yn = EXCLUDED.use_yn
    , upd_user = EXCLUDED.upd_user
    , upd_dtm = CURRENT_TIMESTAMP
  </insert>

  <insert id="saveFactorValue">
    INSERT INTO tb_factor_value_c (
        factor_value_code,
        factor_value_name,
        value,
        factor_code,
        use_yn,
        rgst_user,
        rgst_dtm,
        upd_user,
        upd_dtm
    )
    VALUES (
        (SELECT
            CASE
                WHEN EXISTS (SELECT 1 FROM tb_factor_value_c b WHERE b.factor_value_code = #{factorValueCode})
                THEN #{factorValueCode}
                ELSE 'FCVL' || LPAD(CAST((COALESCE(MAX(CAST(RIGHT(a.factor_value_code, 6) AS INTEGER)), 0) + 1) AS TEXT), 6, '0')
            END
         FROM tb_factor_value_c a
         WHERE a.factor_value_code LIKE 'FCVL%'),
        #{factorValueName},
        #{value},
        #{factorCode},
        #{useYn},
        #{rgstUser},
        CURRENT_TIMESTAMP,
        #{updUser},
        CURRENT_TIMESTAMP
    )
    ON CONFLICT (factor_value_code) DO UPDATE
    SET
        factor_value_name = EXCLUDED.factor_value_name,
        value = EXCLUDED.value,
        use_yn = EXCLUDED.use_yn,
        upd_user = EXCLUDED.upd_user,
        upd_dtm = CURRENT_TIMESTAMP
  </insert>

  <select id="generateNextFactorCode" resultType="java.lang.String">

    SELECT
    'FCTR' || LPAD(
    COALESCE(MAX(
    CAST(RIGHT(a.factor_code, 6) AS INTEGER)
    ) + 1, 0)::TEXT, 6, '0'
    ) AS next_code
    FROM tb_factor_c a
    WHERE
    a.factor_code LIKE 'FCTR%'

  </select>

  <select id="findExistingFactorNames" resultType="string">
    SELECT
    a.factor_name
    FROM tb_factor_c a
    WHERE
    UPPER(a.factor_name) IN
    <foreach item='name' collection='factorNames' open='(' separator=',' close=")">
    UPPER(#{name})
    </foreach>
  </select>

</mapper>