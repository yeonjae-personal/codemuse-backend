<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-multiEntity">

  <select id="retrieveMultiEntitySearchInfo" resultMap="retrieveMultiEntitySearchInfoResultMap">
    SELECT DISTINCT
           a.item_code  AS value
         , a.item_code_name AS label
         , a.item_code  AS cmcdDetlId
         , a.item_code_name AS cmcdDetlNm
         , a.sort_no
    FROM tb_item_c a
    JOIN tb_entity_item_rel_c b ON a.item_code = b.item_code
    WHERE
    b.use_yn = 'Y'
    ORDER BY
    a.sort_no
  </select>

  <resultMap id="retrieveMultiEntitySearchInfoResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    <association property="subOptions" column="{itemCode=value}"  select="retrieveEntityCode"/>
  </resultMap>

  <select id="retrieveEntityCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    SELECT
           b.entity_type_code AS value
         , b.entity_type_name AS label
         , b.entity_type_code AS cmcdDetlId
         , b.entity_type_name AS cmcdDetlNm
    FROM tb_entity_item_rel_c a
    JOIN tb_entity_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    b.use_yn = 'Y'
    AND a.item_code = #{itemCode}
  </select>

  <select id="retrieveMultiEntityList" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityDto">
    SELECT
           a.entity_code
         , a.entity_name
         , a.entity_type_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , c.item_code
         , c.entity_scope
    FROM tb_entity_mpng_d a
    JOIN tb_entity_c b ON b.entity_type_code = a.entity_type_code
    JOIN tb_entity_item_rel_c c ON c.entity_type_code = b.entity_type_code
    <where>
      <if test="itemCode != null">
        c.item_code = #{itemCode}
      </if>
      <if test="entityTypeCode != null">
        AND a.entity_type_code = #{entityTypeCode}
      </if>
      <if test="multiEntityCode != null">
        AND a.entity_code LIKE '%' || UPPER(TRIM(#{multiEntityCode})) || '%'
      </if>
      <if test="multiEntityName != null">
        AND UPPER(a.entity_name) LIKE '%' || UPPER(TRIM(#{multiEntityName})) || '%'
      </if>
      <if test="onlyValidDtm">
        AND (a.valid_end_dtm IS NULL OR a.valid_end_dtm >= CURRENT_TIMESTAMP)
      </if>
    </where>
    ORDER BY
    	a.rgst_dtm DESC
  </select>

  <select id="retrieveEBLDetail" resultMap="retrieveEBLDetailResultMap">
    SELECT
           a.entity_code
         , a.entity_name
         , a.entity_type_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , b.bsn_line_type_code
         , b.ovw_cntn
         , c.item_code
         , #{langCode} as lang_code
    FROM tb_entity_mpng_d a
    JOIN tb_bsn_line_c b ON a.entity_code = b.entity_code
    JOIN tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code
    WHERE
    a.entity_code = #{entityCode}
  </select>

  <resultMap id="retrieveEBLDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.BsnLineDto">
    <association property="additional" column="{entityCode=entity_code,langCode=lang_code}"  select="retrieveAdditionalAndValue"/>
  </resultMap>

  <select id="retrieveEDTDetail" resultMap="retrieveEDTDetailResultMap">
    SELECT
           a.entity_code
         , a.entity_name
         , a.entity_type_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , b.group_uuid
         , b.offer_uuid
         , b.cpnt_uuid
         , b.rsc_uuid
         , b.chrg_type_code
         , b.ovw_cntn
         , c.item_code
         , #{langCode} as lang_code
    FROM tb_entity_mpng_d a
    JOIN tb_dc_trgt_c b ON a.entity_code = b.entity_code
    JOIN tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code
    WHERE
    a.entity_code = #{entityCode}
  </select>

  <resultMap id="retrieveEDTDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.DcTrgtDto">
    <association property="additional" column="{entityCode=entity_code,langCode=lang_code}"  select="retrieveAdditionalAndValue"/>
    <association property="groupName" column="{objUuid=group_uuid}"  select="retrieveEntityObjRelName"/>
    <association property="offerName" column="{objUuid=offer_uuid}"  select="retrieveEntityObjRelName"/>
    <association property="cpntName" column="{objUuid=cpnt_uuid}"  select="retrieveEntityObjRelName"/>
    <association property="rscName" column="{objUuid=rsc_uuid}"  select="retrieveEntityObjRelName"/>
  </resultMap>

  <select id="retrieveESCDetail" resultMap="retrieveESCDetailResultMap">
    SELECT
           a.entity_code
         , a.entity_name
         , a.entity_type_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , b.mvno_bsno_yn
         , b.ovw_cntn
         , c.item_code
         , #{langCode} as lang_code
    FROM tb_entity_mpng_d a
    JOIN tb_sale_cpny_c b ON a.entity_code = b.entity_code
    JOIN tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code
    WHERE
    a.entity_code = #{entityCode}
  </select>

  <resultMap id="retrieveESCDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.SaleCpnyDto">
    <association property="additional" column="{entityCode=entity_code,langCode=lang_code}"  select="retrieveAdditionalAndValue"/>
  </resultMap>

  <select id="retrieveETCDetail" resultMap="retrieveETCDetailResultMap">
    SELECT
           a.entity_code
         , a.entity_name
         , a.entity_type_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , b.item_code
         , #{langCode} as lang_code
    FROM tb_entity_mpng_d a
    JOIN tb_entity_item_rel_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    a.entity_code = #{entityCode}
  </select>

  <resultMap id="retrieveETCDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityDto">
    <association property="additional" column="{entityCode=entity_code,langCode=lang_code}"  select="retrieveAdditionalAndValue"/>
  </resultMap>

  <select id="retrieveAdditionalAndValue" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityAdditionalDto">
    SELECT
           a.attr_uuid
         , a.entity_type_code
         , a.field_type_code
         , a.comm_group_code
         , a.label_id
         <if test="langCode != null">
         	, d.label_dscr	
    	 </if>
         , a.required_yn
         , a.attr_max_length
         , a.sort_no
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , CASE
         WHEN a.field_type_code = 'DM' then (
         SELECT
         COALESCE(JSON_ARRAYAGG(attr_val ORDER BY attr_seq)::TEXT, '[]') AS attr_val
    FROM tb_multi_code_add_attr_val_d
    WHERE
    attr_uuid = a.attr_uuid
    AND obj_uuid = b.entity_code
    )
    ELSE c.attr_val::TEXT
    END AS attr_val
    FROM tb_entity_add_header_m a
    JOIN tb_entity_mpng_d b
    ON b.entity_type_code = a.entity_type_code
    LEFT JOIN tb_entity_add_val_d c
    ON a.attr_uuid = c.attr_uuid
    AND c.entity_code = b.entity_code
    <if test="langCode != null">
      LEFT JOIN tb_multi_lang_label_m d ON d.label_id = a.label_id and d.lang_code = COALESCE(#{langCode}, 'en')
    </if>
    WHERE
    b.entity_code = #{entityCode}
    ORDER BY
    a.sort_no
  </select>

  <select id="retrieveAdditionalByEntityTypeCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityAdditionalDto">
    SELECT
           a.attr_uuid
         , a.entity_type_code
         , a.field_type_code
         , a.comm_group_code
         , a.label_id
         , a.required_yn
         , a.attr_max_length
         , a.sort_no
         , a.rgst_user
         , a.rgst_dtm
         , a.upd_user
         , a.upd_dtm
         , b.label_dscr
    FROM tb_entity_add_header_m a
    LEFT JOIN tb_multi_lang_label_m b ON b.label_id = a.label_id and b.lang_code = COALESCE(#{langCode}, 'en')
    WHERE
    a.entity_type_code = #{entityTypeCode}
    ORDER BY
    a.sort_no
  </select>

  <select id="retrieveEntityObjRelName" resultType="String">
    SELECT
    a.obj_name
    FROM tb_item_mpng_d a
    WHERE
    a.obj_uuid = #{objUuid}
  </select>

  <select id="retrieveNextCodeEntity" resultType="String">
    SELECT
           #{prefix} || LPAD(MAX(SUBSTRING(entity_code, 4)::INTEGER + 1 )::TEXT , 5, '0') as next_code
      FROM tb_entity_mpng_d a
     WHERE a.entity_code LIKE #{prefix} || '%'
  </select>

  <insert id="insertEntityMpng">
    INSERT INTO tb_entity_mpng_d (
        entity_code,
        entity_name,
        entity_type_code,
        valid_start_dtm,
        valid_end_dtm,
        rgst_user,
        rgst_dtm,
        upd_user,
        upd_dtm
    )
    VALUES (
        #{entityCode},
        #{entityName},
        #{entityTypeCode},
        #{validStartDtm}::TIMESTAMP,
        #{validEndDtm}::TIMESTAMP,
        #{rgstUser},
        CURRENT_TIMESTAMP,
        #{updUser},
        CURRENT_TIMESTAMP
    );
  </insert>

  <insert id="insertEntityDcTrgt">
    INSERT INTO tb_dc_trgt_c (
      entity_code
    , group_uuid
    , offer_uuid
    , cpnt_uuid
    , rsc_uuid
    , chrg_type_code
    , ovw_cntn
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    ) VALUES (
      #{entityCode}
    , #{groupUuid}
    , #{offerUuid}
    , #{cpntUuid}
    , #{rscUuid}
    , #{chrgTypeCode}
    , #{ovwCntn}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    )
  </insert>

  <insert id="insertEntitySaleCpny">
    INSERT INTO tb_sale_cpny_c (
      entity_code
    , mvno_bsno_yn
    , ovw_cntn
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    ) VALUES (
      #{entityCode}
    , #{mvnoBsnoYn}
    , #{ovwCntn}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    )
  </insert>

  <insert id="insertEntityBsnLine">
    INSERT INTO tb_bsn_line_c (
      entity_code
    , bsn_line_type_code
    , ovw_cntn
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    ) VALUES (
      #{entityCode}
    , #{bsnLineTypeCode}
    , #{ovwCntn}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP
    )
  </insert>

  <insert id="saveAdditional">
    INSERT INTO tb_entity_add_val_d (
      entity_code
    , attr_uuid
    , attr_val
    , rgst_user
    , rgst_dtm
    , upd_user
    , upd_dtm
    ) VALUES (
      #{entityCode}
    , #{attrUuid}
    , #{attrVal}
    , #{rgstUser}
    , CURRENT_TIMESTAMP
    , #{updUser}
    , CURRENT_TIMESTAMP     )
    ON CONFLICT (entity_code, attr_uuid)
    DO UPDATE SET attr_val = EXCLUDED.attr_val
                , upd_user = EXCLUDED.upd_user
                , upd_dtm  = CURRENT_TIMESTAMP
  </insert>

  <update id="updateEntityMpng">
    UPDATE tb_entity_mpng_d
    <set>
        entity_name = #{entityName},
        valid_start_dtm = #{validStartDtm}::TIMESTAMP,
        valid_end_dtm = #{validEndDtm}::TIMESTAMP,
        upd_user = #{updUser},
        upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE entity_code = #{entityCode}
  </update>

  <update id="updateEntityDcTrgt">
    UPDATE tb_dc_trgt_c
    <set>
      group_uuid = #{groupUuid}
      , offer_uuid = #{offerUuid}
      , cpnt_uuid = #{cpntUuid}
      , rsc_uuid = #{rscUuid}
      , chrg_type_code = #{chrgTypeCode}
      , ovw_cntn = #{ovwCntn}
      , upd_user = #{updUser}
      , upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE
    entity_code = #{entityCode}
  </update>

  <update id="updateEntitySaleCpny">
    UPDATE tb_sale_cpny_c
    <set>
      mvno_bsno_yn = #{mvnoBsnoYn},
      ovw_cntn = #{ovwCntn},
      upd_user = #{updUser},
      upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE
    entity_code = #{entityCode}
  </update>

  <update id="updateEntityBsnLine">
    UPDATE tb_bsn_line_c
    <set>
      bsn_line_type_code = #{bsnLineTypeCode},
      ovw_cntn = #{ovwCntn},
      upd_user = #{updUser},
      upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE
    entity_code = #{entityCode}
  </update>

  <select id="retrieveItemRelation" resultMap="retrieveItemRelationResultMap">
    SELECT
           a.item_code
         , a.entity_type_code
         , a.entity_scope
         , a.sort_no
         , b.entity_type_name
         , #{objUuid} as obj_uuid
         , #{onlyValidDtm} as only_valid_dtm
    FROM tb_entity_item_rel_c a
    JOIN tb_entity_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    a.use_yn  = 'Y'
    AND b.use_yn  = 'Y'
    AND a.item_code = (
    SELECT
    c.item_code
    FROM tb_item_mpng_d c
    WHERE
    c.obj_uuid = #{objUuid}
    )
    ORDER BY
    a.sort_no
  </select>
  
  <select id="retrieveItemRelationExcel" resultMap="retrieveItemRelationResultMapExcel">
    SELECT
           a.item_code
         , a.entity_type_code
         , a.entity_scope
         , a.sort_no
         , b.entity_type_name
         , #{objUuid} as obj_uuid
    FROM tb_entity_item_rel_c a
    JOIN tb_entity_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    a.use_yn  = 'Y'
    AND b.use_yn  = 'Y'
    AND a.item_code = (
    SELECT
    c.item_code
    FROM tb_item_mpng_d c
    WHERE c.obj_uuid = #{objUuid}
    )
    ORDER BY
    a.sort_no
  </select>
  
  <resultMap id="retrieveItemRelationResultMapExcel" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityItemRelResDto">
    <association property="multiEntityExportDtos" column="{entityTypeCode=entity_type_code,objUuid=obj_uuid}" select="retrieveObjRelationExcel"/>
  </resultMap>

  <select id="retrieveObjRelationExcel" resultType="com.lgcns.svcp.prod.ui.prod.dto.export.MultiEntityExportDto">
    SELECT
         c.obj_code as item_code
		 , c.obj_name as item_name
         , a.obj_uuid
         , a.entity_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , b.entity_name
         , b.entity_type_code
         , b.valid_start_dtm as relation_start_date
         , b.valid_end_dtm as relation_end_date
    FROM tb_entity_obj_rel_c a
    JOIN tb_entity_mpng_d b ON a.entity_code = b.entity_code
    JOIN tb_item_mpng_d c ON a.obj_uuid = c.obj_uuid
    WHERE a.obj_uuid = #{objUuid}
    AND b.entity_type_code  = #{entityTypeCode}
  </select>

  <select id="retrieveItemRelationInfo" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityItemRelResDto">
    SELECT
           a.item_code
         , a.entity_type_code
         , a.entity_scope
         , a.sort_no
         , b.entity_type_name
    FROM tb_entity_item_rel_c a
    JOIN tb_entity_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    a.use_yn  = 'Y'
    AND b.use_yn  = 'Y'
    AND a.item_code = #{itemCode}
    ORDER BY
    a.sort_no
  </select>

  <resultMap id="retrieveItemRelationResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityItemRelResDto">
    <association property="objRel" column="{entityTypeCode=entity_type_code,objUuid=obj_uuid,onlyValidDtm=only_valid_dtm}"  select="retrieveObjRelation"/>
  </resultMap>

  <select id="retrieveObjRelation" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityObjRelResDto">
    SELECT
         a.obj_uuid
         , a.entity_code
         , a.valid_start_dtm
         , a.valid_end_dtm
         , b.entity_name
         , b.entity_type_code
         , b.valid_start_dtm as item_valid_start_dtm
         , b.valid_end_dtm as item_valid_end_dtm
    FROM tb_entity_obj_rel_c a
    JOIN tb_entity_mpng_d b ON a.entity_code = b.entity_code
    WHERE
    a.obj_uuid = #{objUuid}
    AND b.entity_type_code  = #{entityTypeCode}
    <if test="onlyValidDtm">
      AND (a.valid_end_dtm IS NULL OR a.valid_end_dtm >= CURRENT_TIMESTAMP)
      AND (b.valid_end_dtm IS NULL OR b.valid_end_dtm >= CURRENT_TIMESTAMP)
    </if>
  </select>

  <insert id="insertObjRelation">
    INSERT INTO tb_entity_obj_rel_c (
          obj_uuid,
          entity_code,
          valid_start_dtm,
          valid_end_dtm,
          rgst_user,
          rgst_dtm,
          upd_user,
          upd_dtm
      )
      VALUES (
          #{objUuid},
          #{entityCode},
          #{validStartDtm}::TIMESTAMP,
          #{validEndDtm}::TIMESTAMP,
          #{rgstUser},
          CURRENT_TIMESTAMP,
          #{updUser},
          CURRENT_TIMESTAMP
      );
  </insert>

  <update id="updateObjRelation">
      UPDATE tb_entity_obj_rel_c
      <set>
          valid_start_dtm = #{validStartDtm}::TIMESTAMP,
          valid_end_dtm = #{validEndDtm}::TIMESTAMP,
          upd_user = #{updUser},
          upd_dtm = CURRENT_TIMESTAMP
      </set>
      WHERE obj_uuid = #{objUuid}
      AND entity_code = #{entityCode}
  </update>

  <select id="retrieveSingleObjRelationOfItem" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityObjRelResDto">
    SELECT
    a.obj_uuid
    , a.entity_code
    , a.valid_start_dtm
    , a.valid_end_dtm
    , b.entity_name
    , b.entity_type_code
    FROM tb_entity_obj_rel_c a
    JOIN tb_entity_mpng_d b ON a.entity_code = b.entity_code
    JOIN tb_entity_item_rel_c c ON b.entity_type_code = c.entity_type_code
    WHERE
    a.obj_uuid = #{objUuid}
    AND c.entity_scope = 'S'
  </select>

  <select id="retrieveEntityScopeByEntityCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityScopeDto">
    SELECT
    a.entity_code
    , b.entity_scope
    FROM tb_entity_mpng_d a
    JOIN tb_entity_item_rel_c b ON a.entity_type_code = b.entity_type_code
    WHERE
    a.entity_code IN
    <foreach item='entityCode' collection='entityCodes' open='(' separator=',' close=")">
      #{entityCode}
    </foreach>
  </select>

  <update id="replaceObjRelation">
    UPDATE tb_entity_obj_rel_c
    <set>
        entity_code = #{entityCode},
        valid_start_dtm = #{validStartDtm}::TIMESTAMP,
        valid_end_dtm = #{validEndDtm}::TIMESTAMP,
        upd_user = #{updUser},
        upd_dtm = CURRENT_TIMESTAMP
    </set>
    WHERE obj_uuid = #{objUuid}
    AND entity_code = #{oldEntityCode}
  </update>

</mapper>