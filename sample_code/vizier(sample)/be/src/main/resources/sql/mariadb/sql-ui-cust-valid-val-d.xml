<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  ~ Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
  ~ Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
  ~ Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
  ~ Vestibulum commodo. Ut rhoncus gravida arcu.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ui-cust-valid-val-d">
	
	<insert id ="insert">
		INSERT INTO tb_cust_valid_val_d
			(valid_code, attr_uuid, cond_type, attr_no, action_item_code, range_start_val, range_end_val, range_start_dtm, range_end_dtm, text_cntn,
			 valid_start_dtm, valid_end_dtm, rgst_user, rgst_dtm, upd_user, upd_dtm)
		VALUES (#{validCode}, #{attrUuid}, #{condType}, #{attrNo}, #{actionItemCode}, #{rangeStartVal}, #{rangeEndVal}, 
				#{rangeStartDtmStr}, #{rangeEndDtmStr}, #{textCntn}, #{validStartDtm}, #{validEndDtm}, #{rgstUser}, now(), #{updUser}, now())
	</insert>
	
	<update id ="update">
		UPDATE tb_cust_valid_val_d
		<set>
			attr_no = #{attrNo},
			range_start_val = #{rangeStartVal},
			range_end_val = #{rangeEndVal},
			range_start_dtm = #{rangeStartDtmStr},
			range_end_dtm = #{rangeEndDtmStr},
			text_cntn = #{textCntn},
			valid_start_dtm = #{validStartDtm},
			valid_end_dtm = #{validEndDtm},
			upd_user = #{updUser},
			upd_dtm = now()
		</set>
		WHERE valid_code = #{validCode} and attr_uuid = #{attrUuid}
	</update>
	
	<select id="getData" resultType="com.lgcns.svcp.prod.entity.CustomValidationExcelEntity">
		select t2.valid_code, t2.attr_uuid, c2.label_id, b.label_name, t2.cond_type, 
		t2.action_item_code ,c1.item_code_name, c1.item_code,
		t2.attr_no, c2.field_type_code, t2.text_cntn, t2.valid_start_dtm, t2.valid_end_dtm,
		t2.range_start_val, t2.range_end_val, t2.range_start_dtm, t2.range_end_dtm, 
		t2.rgst_user, t2.rgst_dtm, t2.upd_user, t2.upd_dtm
		from tb_cust_valid_val_d t2
		inner join tb_item_c c1 on t2.action_item_code = c1.item_code
		inner join tb_add_attr_header_m c2 on t2.attr_uuid = c2.attr_uuid
		left JOIN tb_multi_lang_label_m b ON c2.label_id = b.label_id
		where 1 = 1 and (t2.valid_end_dtm IS NULL OR DATE_FORMAT(t2.valid_end_dtm, '%Y-%m-%d') > DATE_FORMAT(NOW(), '%Y-%m-%d'))
		<if test="language != null">
			and b.lang_code = #{language}
		</if>
		<if test="validCode != null">
			and t2.valid_code = #{validCode}
		</if>
		<if test="itemCode != null">
			and t2.action_item_code = #{itemCode}
		</if>
	</select>
	
	<select id="findAttributeEndValidMain" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.AttributeDto">
		select t1.valid_code, t2.attr_uuid, t1.valid_cntn ,t1.seq_no, t2.cond_type, 
		t2.action_item_code ,c1.item_code_name,
		t2.attr_no ,c2.label_id, c2.field_type_code, t2.text_cntn, c2.comm_group_code,
		t2.range_start_val, t2.range_end_val, t2.range_start_dtm, t2.range_end_dtm, t2.valid_start_dtm, t2.valid_end_dtm,
		c1.lctgr_item_code as large_item_code,
		t2.rgst_user, t2.rgst_dtm, t2.upd_user, t2.upd_dtm, c2.item_code as itemCodeAction, c2.required_yn
		from tb_cust_valid_val_d t2
		inner join tb_cust_valid_m t1 on t1.valid_code = t2.valid_code
		inner join tb_item_c c1 on t2.action_item_code = c1.item_code
		inner join tb_add_attr_header_m c2 on t2.attr_uuid = c2.attr_uuid
		where 1 = 1
		and t2.valid_code = #{validCode}
		and (t2.valid_end_dtm IS NULL OR DATE_FORMAT(t2.valid_end_dtm, '%Y-%m-%d') > DATE_FORMAT(NOW(), '%Y-%m-%d'))
	</select>
	
	<select id="countByProperties" resultType="int">
		SELECT count(*)
        FROM tb_cust_valid_val_d t
        WHERE t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid}
	</select>
	
	<select id="countByCondTypeAndAttribute" resultType="int">
		SELECT count(*)
        FROM tb_cust_valid_val_d t
        WHERE t.cond_type = #{condType} and t.attr_uuid = #{attrUuid}
	</select>
	
	<select id="findAttributeEndValid" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.AttributeDto">
		SELECT t.valid_code, t.attr_uuid, t.valid_end_dtm, t.cond_type
        FROM tb_cust_valid_val_d t
        WHERE t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid} 
        and (t.valid_end_dtm IS NULL OR DATE_FORMAT(t.valid_end_dtm, '%Y-%m-%d') > DATE_FORMAT(NOW(), '%Y-%m-%d'))
	</select>
	
	<select id="findByValidCodeAndEndValid" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.AttributeDto">
		SELECT * FROM tb_cust_valid_val_d t
        WHERE t.valid_code = #{validCode} 
        and (t.valid_end_dtm IS NULL OR DATE_FORMAT(t.valid_end_dtm, '%Y-%m-%d') >= DATE_FORMAT(NOW(), '%Y-%m-%d'))
	</select>
	
	<select id="findByValidCodeAndAttrUuid" resultType="com.lgcns.svcp.prod.ui.prod.dto.customvalidation.AttributeDto">
		SELECT t.valid_code, t.attr_uuid, t.cond_type, t.attr_no, t.action_item_code, t.range_start_val, t.range_end_val, t.range_start_dtm, t.range_end_dtm, t.text_cntn,
			 t.valid_start_dtm, t.valid_end_dtm, t.rgst_user, t.rgst_dtm, t.upd_user, t.upd_dtm, t.valid_end_dtm as validEndDtmOrigin
			 FROM tb_cust_valid_val_d t
        	 WHERE t.valid_code = #{validCode} and t.attr_uuid = #{attrUuid}
	</select>
</mapper>