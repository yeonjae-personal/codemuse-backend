<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  ~ Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
  ~ Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
  ~ Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
  ~ Vestibulum commodo. Ut rhoncus gravida arcu.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-multiEntity">

	<select id="retrieveMultiEntitySearchInfo" resultMap="retrieveMultiEntitySearchInfoResultMap">
		SELECT DISTINCT 
			a.item_code  AS value
			, a.item_code_name AS label
			, a.item_code  AS cmcdDetlId
			, a.item_code_name AS cmcdDetlNm
			, a.sort_no
		FROM
			tb_item_c a
		JOIN
			tb_entity_item_rel_c b ON a.item_code = b.item_code
		WHERE
			b.use_yn = 'Y'
		ORDER BY
			a.sort_no
	</select>
	
	<resultMap id="retrieveMultiEntitySearchInfoResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
    	<association property="subOptions" column="{itemCode=value}"  select="retrieveEntityCode"/>
	</resultMap>
	
	<select id="retrieveEntityCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.common.SelectOptionDto">
		SELECT 
			b.entity_type_code AS value
			, b.entity_type_name AS label
			, b.entity_type_code AS cmcdDetlId
			, b.entity_type_name AS cmcdDetlNm
		FROM 
			tb_entity_item_rel_c a
		JOIN
			tb_entity_c b ON a.entity_type_code = b.entity_type_code
		WHERE
			b.use_yn = 'Y'
			AND a.item_code = #{itemCode}
	</select>
	
	<select id="retrieveMultiEntityList" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityDto">
		SELECT
			a.entity_code
			, a.entity_name
			, a.entity_type_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
			, c.item_code
			, c.entity_scope
		FROM 
			tb_entity_mpng_d a
		JOIN
			tb_entity_c b ON b.entity_type_code = a.entity_type_code
		JOIN
			tb_entity_item_rel_c c ON c.entity_type_code = b.entity_type_code
		<where>
			<if test="itemCode != null">
				c.item_code = #{itemCode}
			</if>
			<if test="entityTypeCode != null">
				AND a.entity_type_code = #{entityTypeCode}
			</if>
			<if test="multiEntityCode != null">
				AND a.entity_code LIKE CONCAT('%', UPPER(TRIM(#{multiEntityCode})),'%')
			</if>
			<if test="multiEntityName != null">
				AND UPPER(a.entity_name) LIKE CONCAT('%', UPPER(TRIM(#{multiEntityName})),'%')
			</if>
			<if test="onlyValidDtm">
		        AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
		    </if>
		</where>
	</select>
	
	<select id="retrieveEBLDetail" resultMap="retrieveEBLDetailResultMap" >
		SELECT
			a.entity_code
			, a.entity_name
			, a.entity_type_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
			, b.bsn_line_type_code
			, b.ovw_cntn
			, c.item_code
		FROM
			tb_entity_mpng_d a
		JOIN
			tb_bsn_line_c b ON a.entity_code = b.entity_code
		JOIN
			tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code 
		WHERE
			a.entity_code = #{entityCode}
	</select>
	
	<resultMap id="retrieveEBLDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.BsnLineDto">
	   <association property="additional" column="{entityCode=entity_code}"  select="retrieveAdditionalAndValue"/>
    </resultMap>
	
	
	<select id="retrieveEDTDetail" resultMap="retrieveEDTDetailResultMap" >
		SELECT
			a.entity_code
			, a.entity_name
			, a.entity_type_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
			, b.group_uuid
			, b.offer_uuid
			, b.cpnt_uuid
			, b.rsc_uuid
			, b.chrg_type_code
			, b.ovw_cntn
			, c.item_code
		FROM 
			tb_entity_mpng_d a
		JOIN 
			tb_dc_trgt_c b ON a.entity_code = b.entity_code
		JOIN
			tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code 
		WHERE
			a.entity_code = #{entityCode}
	</select>
	
	<resultMap id="retrieveEDTDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.DcTrgtDto">
	  <association property="additional" column="{entityCode=entity_code}"  select="retrieveAdditionalAndValue"/>
	  <association property="groupName" column="{objUuid=group_uuid}"  select="retrieveEntityObjRelName"/>
	  <association property="offerName" column="{objUuid=offer_uuid}"  select="retrieveEntityObjRelName"/>
	  <association property="cpntName" column="{objUuid=cpnt_uuid}"  select="retrieveEntityObjRelName"/>
	  <association property="rscName" column="{objUuid=rsc_uuid}"  select="retrieveEntityObjRelName"/>
    </resultMap>
    
    
    <select id="retrieveESCDetail" resultMap="retrieveESCDetailResultMap" >
		SELECT
			a.entity_code
			, a.entity_name
			, a.entity_type_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
			, b.mvno_bsno_yn
			, b.ovw_cntn
			, c.item_code
		FROM 
			tb_entity_mpng_d a
		JOIN 
			tb_sale_cpny_c b ON a.entity_code = b.entity_code
		JOIN
			tb_entity_item_rel_c c ON a.entity_type_code = c.entity_type_code 
		WHERE
			a.entity_code = #{entityCode}
	</select>
	
	<resultMap id="retrieveESCDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.detail.SaleCpnyDto">
	   <association property="additional" column="{entityCode=entity_code}"  select="retrieveAdditionalAndValue"/>
    </resultMap>
    
    <select id="retrieveETCDetail" resultMap="retrieveETCDetailResultMap" >
		SELECT
			a.entity_code
			, a.entity_name
			, a.entity_type_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
			, b.item_code 
		FROM 
			tb_entity_mpng_d a
		JOIN
			tb_entity_item_rel_c b ON a.entity_type_code = b.entity_type_code 
		WHERE
			a.entity_code = #{entityCode}
	</select>
	
	<resultMap id="retrieveETCDetailResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityDto">
	   <association property="additional" column="{entityCode=entity_code}"  select="retrieveAdditionalAndValue"/>
    </resultMap>
	
	<select id="retrieveAdditionalAndValue" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityAdditionalDto">
		SELECT 
			a.attr_uuid
			, a.entity_type_code
			, a.field_type_code
			, a.comm_group_code
			, a.label_id
			, a.required_yn
			, a.maxlength
			, a.sort_no
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
	        , CASE 
				WHEN a.field_type_code = 'DM' then (
													SELECT
														COALESCE(JSON_ARRAYAGG(attr_val), '[]') AS attr_val
													FROM
														tb_multi_code_add_attr_val_d
													WHERE
														attr_uuid = a.attr_uuid 
														AND obj_uuid = b.entity_code
													ORDER BY
														attr_seq
													)
				ELSE c.attr_val
			END AS attr_val
		FROM 
		    tb_entity_add_header_m a
		JOIN tb_entity_mpng_d b
		    ON b.entity_type_code = a.entity_type_code
		LEFT JOIN tb_entity_add_val_d c 
		    ON a.attr_uuid = c.attr_uuid
		    AND c.entity_code = b.entity_code
		WHERE 
			b.entity_code = #{entityCode}
		ORDER BY 
			a.sort_no
	</select>
	
	<select id="retrieveAdditionalByEntityTypeCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityAdditionalDto">
		SELECT
			a.attr_uuid
			, a.entity_type_code
			, a.field_type_code
			, a.comm_group_code
			, a.label_id
			, a.required_yn
			, a.maxlength
			, a.sort_no
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
		FROM
			tb_entity_add_header_m a
		WHERE
			a.entity_type_code = #{entityTypeCode}
		ORDER BY 
			a.sort_no
	</select>
	
	<select id="retrieveEntityObjRelName" resultType="String">
		SELECT 
			a.obj_name
		FROM
			tb_item_mpng_d a
		WHERE
			a.obj_uuid = #{objUuid}
	</select>
	
	<select id="retrieveNextCodeEntity" resultType="String">
	    SELECT 
	        CONCAT(#{prefix}, LPAD(CAST(IFNULL(MAX(CAST(SUBSTRING(a.entity_code, 4) AS UNSIGNED)), 0) + 1 AS CHAR), 5, '0')) AS next_code
	    FROM 
	        tb_entity_mpng_d a
	    WHERE 
	        a.entity_code LIKE CONCAT(#{prefix}, '%')
	</select>
	
	<insert id="insertEntityMpng" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.create.CreateEntityReqDto">
		INSERT INTO tb_entity_mpng_d (
	        entity_code
			, entity_name
			, entity_type_code
			, valid_start_dtm
			, valid_end_dtm
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{entityCode}
	        , #{entityName}
	        , #{entityTypeCode}
	        , #{validStartDtm}
			, DATE_FORMAT(DATE(#{validEndDtm}) , '%Y-%m-%d 23:59:59')
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	</insert>
	
	<insert id="insertEntityDcTrgt" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.create.CreateEntityReqDto">
		INSERT INTO tb_dc_trgt_c (
	        entity_code
			, group_uuid
			, offer_uuid
			, cpnt_uuid
			, rsc_uuid
			, chrg_type_code
			, ovw_cntn
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{entityCode}
	        , #{groupUuid}
			, #{offerUuid}
			, #{cpntUuid}
			, #{rscUuid}
			, #{chrgTypeCode}
			, #{ovwCntn}
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	</insert>
	
	<insert id="insertEntitySaleCpny" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.create.CreateEntityReqDto">
		INSERT INTO tb_sale_cpny_c (
	        entity_code
			, mvno_bsno_yn
			, ovw_cntn
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{entityCode}
			, #{mvnoBsnoYn}
			, #{ovwCntn}
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	</insert>
	
	<insert id="insertEntityBsnLine" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.create.CreateEntityReqDto">
		INSERT INTO tb_bsn_line_c (
	        entity_code
			, bsn_line_type_code
			, ovw_cntn
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{entityCode}
			, #{bsnLineTypeCode}
			, #{ovwCntn}
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	</insert>
	
	<insert id="saveAdditional" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.MultiEntityAdditionalDto">
		INSERT INTO tb_entity_add_val_d (
	        entity_code
			, attr_uuid
			, attr_val
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{entityCode}
	        , #{attrUuid}
			, #{attrVal}
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	      ON DUPLICATE KEY UPDATE
			attr_val = VALUES(attr_val)
			, upd_user = VALUES(upd_user)
			, upd_dtm = VALUES(upd_dtm)
	</insert>
	
	<update id="updateEntityMpng" >
		UPDATE tb_entity_mpng_d
			<set>
				entity_name = #{entityName},
				valid_start_dtm = #{validStartDtm},
				valid_end_dtm = #{validEndDtm},
				upd_user = #{updUser},
				upd_dtm = #{updDtm}
			</set>
		WHERE
			entity_code = #{entityCode}
	</update>
	
	<update id="updateEntityDcTrgt" >
		UPDATE tb_dc_trgt_c
			<set>
				group_uuid = #{groupUuid}
				, offer_uuid = #{offerUuid}
				, cpnt_uuid = #{cpntUuid}
				, rsc_uuid = #{rscUuid}
				, chrg_type_code = #{chrgTypeCode}
				, ovw_cntn = #{ovwCntn}
				, upd_user = #{updUser}
				, upd_dtm = #{updDtm}
			</set>
		WHERE
			entity_code = #{entityCode}
	</update>
	
	<update id="updateEntitySaleCpny" >
		UPDATE tb_sale_cpny_c
			<set>
				mvno_bsno_yn = #{mvnoBsnoYn},
				ovw_cntn = #{ovwCntn},
				upd_user = #{updUser},
				upd_dtm = #{updDtm}
			</set>
		WHERE
			entity_code = #{entityCode}
	</update>
	
	<update id="updateEntityBsnLine" >
		UPDATE tb_bsn_line_c
			<set>
				bsn_line_type_code = #{bsnLineTypeCode},
				ovw_cntn = #{ovwCntn},
				upd_user = #{updUser},
				upd_dtm = #{updDtm}
			</set>
		WHERE
			entity_code = #{entityCode}
	</update>
	
	<select id="retrieveItemRelation" resultMap="retrieveItemRelationResultMap" >
		SELECT 
			a.item_code
			, a.entity_type_code
			, a.entity_scope
			, a.sort_no
			, b.entity_type_name
			, #{objUuid} as obj_uuid
			, #{onlyValidDtm} as only_valid_dtm
		FROM
			tb_entity_item_rel_c a
		JOIN
			tb_entity_c b ON a.entity_type_code = b.entity_type_code 
		WHERE
			a.use_yn  = 'Y'
			AND b.use_yn  = 'Y'
			AND a.item_code = (
				SELECT
					c.item_code
				FROM
					tb_item_mpng_d c
				WHERE
					c.obj_uuid = #{objUuid}
			)
		ORDER BY
			a.sort_no
	</select>
	
	
	<select id="retrieveItemRelationInfo" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityItemRelResDto" >
    	SELECT 
			a.item_code
			, a.entity_type_code
			, a.entity_scope
			, a.sort_no
			, b.entity_type_name
		FROM
			tb_entity_item_rel_c a
		JOIN
			tb_entity_c b ON a.entity_type_code = b.entity_type_code 
		WHERE
			a.use_yn  = 'Y'
			AND b.use_yn  = 'Y'
			AND a.item_code = #{itemCode}
		ORDER BY
			a.sort_no 
	</select>

	<resultMap id="retrieveItemRelationResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityItemRelResDto">
    	<association property="objRel" column="{entityTypeCode=entity_type_code,objUuid=obj_uuid,onlyValidDtm=only_valid_dtm}"  select="retrieveObjRelation"/>
	</resultMap>
	
	<select id="retrieveObjRelation" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityObjRelResDto" >
		SELECT 
			a.obj_uuid
			, a.entity_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, b.entity_name
			, b.entity_type_code
			, b.valid_start_dtm as item_valid_start_dtm
			, b.valid_end_dtm as item_valid_end_dtm
		FROM
			tb_entity_obj_rel_c a
		JOIN
			tb_entity_mpng_d b ON a.entity_code = b.entity_code 
		WHERE
			a.obj_uuid = #{objUuid}
			AND b.entity_type_code  = #{entityTypeCode}
			<if test="onlyValidDtm">
				AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
				AND (b.valid_end_dtm IS NULL OR TIMESTAMP(b.valid_end_dtm) >= NOW())
			</if>
	</select>
	
	<insert id="insertObjRelation" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.SaveEntityObjRelReqDto">
		INSERT INTO tb_entity_obj_rel_c (
	        obj_uuid
			, entity_code
			, valid_start_dtm
			, valid_end_dtm
			, rgst_user
			, rgst_dtm
			, upd_user
			, upd_dtm
	    ) VALUES (
	        #{objUuid}
	        , #{entityCode}
			, #{validStartDtm}
			, DATE_FORMAT(DATE(#{validEndDtm}) , '%Y-%m-%d 23:59:59')
			, #{rgstUser}
			, #{rgstDtm}
			, #{updUser}
			, #{updDtm}
	    )
	</insert>
	
	<update id="updateObjRelation" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.SaveEntityObjRelReqDto">
		UPDATE tb_entity_obj_rel_c
			<set>
				valid_start_dtm = #{validStartDtm},
				valid_end_dtm = #{validEndDtm},
				upd_user = #{updUser},
				upd_dtm = #{updDtm}
			</set>
		WHERE
			obj_uuid = #{objUuid}
			AND entity_code = #{entityCode}
	</update>
	
	<select id="retrieveSingleObjRelationOfItem" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityObjRelResDto" >
         SELECT 
			a.obj_uuid
			, a.entity_code
			, a.valid_start_dtm
			, a.valid_end_dtm
			, b.entity_name
			, b.entity_type_code 
         FROM
         	tb_entity_obj_rel_c a
         JOIN
         	tb_entity_mpng_d b ON a.entity_code = b.entity_code
         JOIN
         	tb_entity_item_rel_c c ON b.entity_type_code = c.entity_type_code 
         WHERE
         	a.obj_uuid = #{objUuid}
         	AND c.entity_scope = 'S'
	</select>
	
	<select id="retrieveEntityScopeByEntityCode" resultType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.EntityScopeDto" >
		SELECT
			a.entity_code
			, b.entity_scope 
		FROM
			tb_entity_mpng_d a
		JOIN
			tb_entity_item_rel_c b ON a.entity_type_code = b.entity_type_code 
		WHERE
			a.entity_code IN
		   	<foreach item="entityCode" collection="entityCodes" open="(" separator="," close=")">
		        #{entityCode}
		    </foreach>
	</select>
	
	<update id="replaceObjRelation" parameterType="com.lgcns.svcp.prod.ui.prod.dto.multiEntity.rel.SaveEntityObjRelReqDto">
		UPDATE tb_entity_obj_rel_c
			<set>
				entity_code = #{entityCode}
				, valid_start_dtm = #{validStartDtm}
				, valid_end_dtm = #{validEndDtm}
				, upd_user = #{updUser}
				, upd_dtm = #{updDtm}
			</set>
		WHERE
			obj_uuid = #{objUuid}
			AND entity_code = #{oldEntityCode}
	</update>
</mapper>