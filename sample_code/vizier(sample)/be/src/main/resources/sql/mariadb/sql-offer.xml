<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  ~ Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
  ~ Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
  ~ Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
  ~ Vestibulum commodo. Ut rhoncus gravida arcu.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Offer">
	
	<select id="selectPricePlanList" resultType="java.util.LinkedHashMap">
	    SELECT a.obj_uuid
			, a.obj_code
			, a.obj_name
			, a.ovw_cntn
			, a.dplc_trgt_uuid
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
	      <foreach collection="additionalColumns" item="column" separator="," open = ",">
	        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
	      </foreach>
		    FROM tb_item_mpng_d a
		    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
            WHERE a.item_code = 'PP'
	    	GROUP BY a.obj_uuid
	    	ORDER BY a.rgst_dtm, b.sort_no DESC
	    	LIMIT 300
	</select>
	
	<select id="selectPricePlan" resultType="java.util.LinkedHashMap">
	    SELECT a.obj_uuid
			, a.obj_code
			, a.obj_name
			, a.ovw_cntn
			, a.dplc_trgt_uuid
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
	      <foreach collection="additionalColumns" item="column" separator="," open = ",">
	        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
	      </foreach>
		    FROM tb_item_mpng_d a
		    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
            WHERE 1 = 1
            AND   a.obj_code = #{ppCode}
	    	GROUP BY a.obj_uuid
	</select>
	
  	  <select id="selectAddOnList" resultType="java.util.LinkedHashMap">
		    SELECT a.obj_uuid
				, a.obj_code
				, a.obj_name
				, a.ovw_cntn
				, a.dplc_trgt_uuid
				, a.valid_start_dtm
				, a.valid_end_dtm
				, a.rgst_user
				, a.rgst_dtm
				, a.upd_user
				, a.upd_dtm
		      <foreach collection="additionalColumns" item="column" separator="," open = ",">
		        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
		      </foreach>
			    FROM tb_item_mpng_d a
			    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
	            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
	            WHERE 1 = 1
	            ANd   a.item_code = 'AO'
		    	GROUP BY a.obj_uuid
		    	ORDER BY a.rgst_dtm , b.sort_no DESC
	  </select>
	  
	  <select id="selectAddOn" resultType="java.util.LinkedHashMap">
		    SELECT a.obj_uuid
				, a.obj_code
				, a.obj_name
				, a.ovw_cntn
				, a.dplc_trgt_uuid
				, a.valid_start_dtm
				, a.valid_end_dtm
				, a.rgst_user
				, a.rgst_dtm
				, a.upd_user
				, a.upd_dtm
		      <foreach collection="additionalColumns" item="column" separator="," open = ",">
		        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
		      </foreach>
			    FROM tb_item_mpng_d a
			    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
	            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
	            WHERE 1 = 1
	            AND   a.obj_code = #{addonCode}
		    	GROUP BY a.obj_uuid
	  </select>
  
  <select id="selectDiscountList" resultType="java.util.LinkedHashMap">
	    SELECT a.obj_uuid
			, a.obj_code
			, a.obj_name
			, a.ovw_cntn
			, a.dplc_trgt_uuid
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
	      <foreach collection="additionalColumns" item="column" separator="," open = ",">
	        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
	      </foreach>
		    FROM tb_item_mpng_d a
		    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
            WHERE a.item_code = 'DC'
	    	GROUP BY a.obj_uuid
	    	ORDER BY a.rgst_dtm DESC
  </select>
  
  <select id="selectDiscount" resultType="java.util.LinkedHashMap">
	    SELECT a.obj_uuid
			, a.obj_code
			, a.obj_name
			, a.ovw_cntn
			, a.dplc_trgt_uuid
			, a.valid_start_dtm
			, a.valid_end_dtm
			, a.rgst_user
			, a.rgst_dtm
			, a.upd_user
			, a.upd_dtm
	      <foreach collection="additionalColumns" item="column" separator="," open = ",">
	        MAX(CASE WHEN b.attr_uuid = '${column.attrUuid}' THEN c.attr_val END) AS '${column.attrName}'
	      </foreach>
		    FROM tb_item_mpng_d a
		    LEFT JOIN tb_offer_add_attr_val_d c ON a.obj_uuid = c.obj_uuid
            LEFT JOIN tb_add_attr_header_m b ON c.attr_uuid  = b.attr_uuid
            WHERE 1 = 1
            AND   a.obj_code = #{dcCode}
	    	GROUP BY a.obj_uuid
  </select>
  
</mapper>