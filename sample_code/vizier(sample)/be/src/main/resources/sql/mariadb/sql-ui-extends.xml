<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2023. Lorem ipsum dolor sit amet, consectetur adipiscing elit.
  ~ Morbi non lorem porttitor neque feugiat blandit. Ut vitae ipsum eget quam lacinia accumsan.
  ~ Etiam sed turpis ac ipsum condimentum fringilla. Maecenas magna.
  ~ Proin dapibus sapien vel ante. Aliquam erat volutpat. Pellentesque sagittis ligula eget metus.
  ~ Vestibulum commodo. Ut rhoncus gravida arcu.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Ui-extends">
    <select id="getTargetLeader"  resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.OffrGrpResDto">
 		SELECT DISTINCT
			  a.obj_uuid AS offer_group_uuid
			  , a.obj_code AS offer_group_code
			  , a.obj_name AS offer_group_name
			  , #{onlyValidDtm} AS only_valid_dtm
		FROM
			tb_item_mpng_d a
		JOIN
			tb_offer_group_rel_d b  ON a.obj_uuid = b.offer_group_uuid 
		JOIN
			tb_offer_dpdc_rel_d c ON a.obj_uuid = c.base_uuid
		WHERE
			b.offer_uuid = #{offerUuid}
    </select>

    <select id="getTargetFollower"  resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.OffrGrpResDto">
 		SELECT DISTINCT
			  a.obj_uuid AS offer_group_uuid
			  , a.obj_code AS offer_group_code
			  , a.obj_name AS offer_group_name
			  , #{onlyValidDtm} AS only_valid_dtm
			  , b.offer_uuid
		FROM
			tb_item_mpng_d a
		JOIN
			tb_offer_group_rel_d b  ON a.obj_uuid = b.offer_group_uuid 
		JOIN
			tb_offer_dpdc_rel_d c ON a.obj_uuid = c.trgt_uuid
		WHERE
			b.offer_uuid = #{offerUuid}
    </select>
    
	<select id="getBaseUuids" resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.OfferDpdcRelDto" parameterType="java.util.List">
	    SELECT
	        a.base_uuid
	        , a.trgt_uuid
	        , a.dpdc_rel_uuid
	        , a.valid_start_dtm
	        , a.valid_end_dtm
	    FROM
	        tb_offer_dpdc_rel_d a
	    WHERE
	        a.trgt_uuid IN
	        <foreach collection="referenceUuids" item="uuid" open="(" separator="," close=")">
	            #{uuid}
	        </foreach>
	</select>
	    
	<select id="getTargetUuids" resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.OfferDpdcRelDto" parameterType="java.util.List">
	    SELECT
	        a.base_uuid
	        , a.trgt_uuid
	        , a.dpdc_rel_uuid
	        , a.valid_start_dtm
	        , a.valid_end_dtm
	    FROM
	        tb_offer_dpdc_rel_d a
	    WHERE
	        a.base_uuid IN
	        <foreach collection="referenceUuids" item="uuid" open="(" separator="," close=")">
	            #{uuid}
	        </foreach>
	</select>
    
    <select id="getLeaderView"  resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.RelationViewResDto">
    	SELECT
    		d.obj_uuid AS dpdc_rel_uuid,
			d.obj_code AS dpdc_rel_code,
			d.obj_name AS dpdc_rel_name,
			b.obj_uuid AS target_uuid,
			b.obj_code AS target_code,
			b.obj_name AS target_name,
			b.item_code,
			e.item_code_name,
			CASE
    			WHEN e.lctgr_item_code = 'G' THEN b.obj_uuid
				ELSE NULL
			END AS offer_group_uuid,
			a.valid_start_dtm,
			a.valid_end_dtm,
			b.valid_start_dtm AS item_valid_start_dtm,
			b.valid_end_dtm AS item_valid_end_dtm,
			a.base_uuid AS reference_uuid,
			g.lctgr_item_name,
			a.trgt_uuid AS parent_uuid
		FROM tb_offer_dpdc_rel_d a
			JOIN tb_item_mpng_d b ON a.base_uuid = b.obj_uuid
			JOIN tb_item_mpng_d d ON a.dpdc_rel_uuid = d.obj_uuid 
			JOIN tb_item_c e ON b.item_code = e.item_code
			JOIN tb_mctgr_item_c f ON e.mctgr_item_code = f.mctgr_item_code 
			JOIN tb_lctgr_item_c g ON f.lctgr_item_code = g.lctgr_item_code
		<where>
			<if test="onlyValidDtm">
		        AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
		        AND (b.valid_end_dtm IS NULL OR TIMESTAMP(b.valid_end_dtm) >= NOW())
		     </if>
			AND (a.trgt_uuid = #{targetUuid}
				<if test="includeGroup">
					OR a.trgt_uuid in (
						SELECT DISTINCT
						  a.offer_group_uuid
						FROM
							tb_offer_group_rel_d a
						JOIN
							tb_offer_dpdc_rel_d b ON a.offer_group_uuid = b.trgt_uuid
						WHERE
							a.offer_uuid = #{targetUuid}
						<if test="onlyValidDtm">
					        AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
					        AND (b.valid_end_dtm IS NULL OR TIMESTAMP(b.valid_end_dtm) >= NOW())
				        </if>
					)
				</if>
			)
		</where>
    </select>
   
    <select id="getFollowerView"  resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.RelationViewResDto">
		SELECT
    		d.obj_uuid AS dpdc_rel_uuid,
			d.obj_code AS dpdc_rel_code,
			d.obj_name AS dpdc_rel_name,
			b.obj_uuid AS target_uuid,
			b.obj_code AS target_code,
			b.obj_name AS target_name,
			b.item_code,
			e.item_code_name,
			CASE
    			WHEN e.lctgr_item_code = 'G' THEN b.obj_uuid
				ELSE NULL
			END AS offer_group_uuid,
			a.valid_start_dtm,
			a.valid_end_dtm,
			b.valid_start_dtm AS item_valid_start_dtm,
			b.valid_end_dtm AS item_valid_end_dtm,
			a.trgt_uuid AS reference_uuid,
			g.lctgr_item_name,
			a.base_uuid AS parent_uuid
		FROM tb_offer_dpdc_rel_d a
			JOIN tb_item_mpng_d b ON a.trgt_uuid = b.obj_uuid
			JOIN tb_item_mpng_d d ON a.dpdc_rel_uuid = d.obj_uuid 
			JOIN tb_item_c e ON b.item_code = e.item_code
			JOIN tb_mctgr_item_c f ON e.mctgr_item_code = f.mctgr_item_code 
			JOIN tb_lctgr_item_c g ON f.lctgr_item_code = g.lctgr_item_code
		<where>
			<if test="onlyValidDtm">
		        AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
		        AND (b.valid_end_dtm IS NULL OR TIMESTAMP(b.valid_end_dtm) >= NOW())
		    </if>
			AND (a.base_uuid = #{targetUuid}
				<if test="includeGroup">
					OR a.base_uuid in (
						SELECT DISTINCT
						  a.offer_group_uuid
						FROM
							tb_offer_group_rel_d a
						JOIN
							tb_offer_dpdc_rel_d b ON a.offer_group_uuid = b.base_uuid
						WHERE
							a.offer_uuid = #{targetUuid}
						<if test="onlyValidDtm">
					        AND (a.valid_end_dtm IS NULL OR TIMESTAMP(a.valid_end_dtm) >= NOW())
					        AND (b.valid_end_dtm IS NULL OR TIMESTAMP(b.valid_end_dtm) >= NOW())
				        </if>
					)
				</if>
			)
		</where>
    </select>
 
 	<resultMap id="retrieveRelationListResultMap" type="com.lgcns.svcp.prod.ui.prod.dto.extend.RelationResDto">
		<collection property="general"  column="{objUuid=dpdc_rel_uuid}" select="Ui-item.retrieveGeneral"/>
		<collection property="additional"  column="{objUuid=dpdc_rel_uuid}" select="retrieveAdditional"/>
	</resultMap>
    <select id="retrieveRelationList" resultMap="retrieveRelationListResultMap" >
	    SELECT
	    	a.obj_uuid as dpdc_rel_uuid,
			a.obj_code as dpdc_rel_code,
			a.obj_name as dpdc_rel_name,
			a.item_code,
			a.valid_start_dtm,
			a.valid_end_dtm,
			a.rgst_user,
			a.rgst_dtm,
			a.upd_user,
			a.upd_dtm,
			a.obj_uuid
		FROM
			tb_item_mpng_d a
		JOIN
			tb_item_c b ON a.item_code = b.item_code
		<where>
			b.lctgr_item_code = 'B'
			<if test="dpdcRelCd != null">
				AND UPPER(a.obj_code) LIKE <![CDATA[ CONCAT('%', UPPER(#{dpdcRelCd}),'%')]]>
			</if>
			<if test="dpdcRelNm != null">
				AND UPPER(a.obj_name) LIKE <![CDATA[ CONCAT('%', UPPER(#{dpdcRelNm}),'%')]]>
			</if>
	    </where>
    </select>
    
    <insert id="insertOfferDpdc" parameterType="com.lgcns.svcp.prod.ui.prod.dto.extend.OffrDpdcReqDto">
	    INSERT INTO tb_offer_dpdc_rel_d (
	        base_uuid,
	        trgt_uuid,
	        dpdc_rel_uuid,
	        valid_start_dtm,
	        valid_end_dtm,
	        rgst_user,
	        rgst_dtm,
	        upd_user,
	        upd_dtm
	    ) VALUES (
	        #{baseUuid},
	        #{trgtUuid},
	        #{dpdcRelUuid},
	        #{validStartDtm},
	        DATE_FORMAT(DATE(#{validEndDtm}) , '%Y-%m-%d 23:59:59'),
			#{rgstUser},
			#{rgstDtm},
			#{updUser},
			#{updDtm}
	    )
    </insert>
    
   <update id="updateOfferDpdc"  parameterType="com.lgcns.svcp.prod.ui.prod.dto.extend.OffrDpdcReqDto" >
    UPDATE tb_offer_dpdc_rel_d
    <set>
		valid_start_dtm = #{validStartDtm},
		valid_end_dtm = DATE_FORMAT(DATE(#{validEndDtm}) , '%Y-%m-%d 23:59:59'),
        upd_user = 'UI',
        upd_dtm = Now()
    </set>
    WHERE base_uuid = #{baseUuid}
      AND trgt_uuid = #{trgtUuid}
      AND dpdc_rel_uuid = #{dpdcRelUuid}
    </update>
	
	<select id="retrieveDpdcRelHist" resultType="com.lgcns.svcp.prod.ui.prod.dto.extend.DpdcRelCodeHistDto"> 
	<![CDATA[
		SELECT
			a.dpdc_rel_code,
			a.attr_code,
			a.apply_start_dtm,
			a.apply_end_dtm,
			a.attr_upd_user,
			a.rgst_user,
			a.rgst_dtm,
			a.upd_user,
			a.upd_dtm,
			a.attr_val
		FROM
			tb_dpdc_rel_code_h a
		WHERE
			a.dpdc_rel_code = #{dpdcRelCode}
	]]>
	</select>
	
	<select id="retrieveAdditional" resultType="com.lgcns.svcp.prod.ui.prod.dto.common.metadata.AdditionalDetailDto">
			SELECT 
	        a.attr_uuid
	        , a.item_code
	        , a.field_type_code
	        , a.comm_group_code
	        , a.sort_no
	        , a.attr_max_length
	        , a.required_yn
	        , a.label_id
	        , a.disp_tab
	        , a.adv_search_yn
		 	, CASE 
			    WHEN a.field_type_code = 'DM' then (
													SELECT
			    										COALESCE(JSON_ARRAYAGG(attr_val), '[]') AS attr_val
													FROM
														tb_multi_code_add_attr_val_d
													WHERE
														attr_uuid = a.attr_uuid
														AND obj_uuid = b.obj_uuid
													ORDER BY
														attr_seq
													)
			    ELSE c.attr_val
			 END AS attr_val
			 , CASE 
				WHEN a.field_type_code = 'OB' then (
													SELECT
														ob_name
													FROM
														(SELECT
															obj_uuid AS ob_code
															, obj_name AS ob_name 
															FROM
																tb_item_mpng_d
															
															UNION
															
															SELECT
																matrix_code AS ob_code
																, matrix_code_name AS ob_name 
															FROM
																tb_matrix_m
														) AS combined
													WHERE
														ob_code =  c.attr_val
													)
				ELSE NULL
			END AS ob_name
		FROM 
		    tb_add_attr_header_m a
		JOIN tb_item_mpng_d b
		    ON b.item_code = a.item_code
		LEFT JOIN tb_offer_rel_add_attr_val_d c 
		    ON a.attr_uuid = c.attr_uuid
		    AND c.obj_uuid = b.obj_uuid
		WHERE 
			a.use_yn = 'Y'
			and  b.obj_uuid = #{objUuid}
		ORDER BY 
			a.sort_no
	</select>
</mapper>